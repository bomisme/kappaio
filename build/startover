#! /bin/bash
# create log files if they are not yet exist, the actually files are created
# in /tmp/, which resides in RAM, and symlinked from /www/docs/, which resides in
# HDD or FLASH
my_rstmp_path=/rstmp
function checkfile_rstmp()
{
[ ! -f $my_rstmp_path/${1} ] && touch $my_rstmp_path/${1} 
if [ ! -f /www/docs/${1} ]; then 
	ln -s $my_rstmp_path/${1} /www/docs/${1}
else
	if [ ! -h /www/docs/${1} ] ; then
			rm /www/docs/${1}
		ln -s $my_rstmp_path/${1} /www/docs/${1}
	fi
fi
}

checkfile_rstmp xmldebuglog.xml
checkfile_rstmp xmlhanstatus.xml
checkfile_rstmp hanstatus.json
checkfile_rstmp debuglog.json

rs_etc_path=/etc/rsserial
[ ! -f $rs_etc_path/zclclusters.json ] && cp ../src/zclclusters.json $rs_etc_path/
[ ! -f $rs_etc_path/zcldatatypes.json ] && cp ../src/zcldatatypes.json $rs_etc_path/
[ ! -f $rs_etc_path/zclprofiles.json ] && cp ../src/zclprofiles.json $rs_etc_path/

if [ $EUID -ne 0 ] 
then
   echo "This script must be run as root" 1>&2
   exit 1
fi
make clean
make
my_rsserial_path=$(pwd)
my_rsserial_PIDF=/run/rsserial.pid
if [ -e "$my_rsserial_PIDF" ]
then	
	rsserial_PID=$(more $my_rsserial_PIDF)
	kill $rsserial_PID
fi
./rsserial
unset my_rsserial_path
unset my_rsserial_PIDF
unset rsserial_PID
